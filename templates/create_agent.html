<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ "Clone | " + agent.name if clone else "OpenProBono | Create Agent" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.png">
    <link rel="stylesheet" href="/static/style_dashboard.css">
    <style>
        .form-section {
            background-color: #F0F0F0; /* Additional background */
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #737373; /* Using a secondary color */
        }
        label {
            font-weight: 600;
            color: #1F1F1F;
        }
        .btn-gradient {
            background: linear-gradient(90deg, #00C9D2, #1340DF, #5C28DF);
            border: none;
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <!-- Include Sidebar Component -->
    {% include 'components/sidebar.html' %}
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üõ†Ô∏è {{ "Clone" if clone else "Create" }} Agent</h1>
            <div class="d-flex align-items-center">
                <a href="/agents" class="btn btn-secondary me-3" onclick="return confirm('Are you sure you want to cancel? Any progress will be lost.');">
                    <i class="bi bi-x-lg"></i> Cancel
                </a>
                {% include 'components/profile_dropdown.html' %}
            </div>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="post" action="{{ url_for('create_agent') }}">
            <!-- Core Agent Configuration -->
            <div class="form-section">
                <h2>Core Agent Configuration</h2>
                <!-- Hidden input to store clone status for JavaScript -->
                <input type="hidden" id="is_clone_mode" value="{{ 'true' if clone else 'false' }}">
                <div class="form-group my-2">
                    <label for="bot_name">Agent Name</label>
                    <input type="text" class="form-control" id="bot_name" name="bot_name" value="{{ agent.name if clone else '' }}" 
                    placeholder="Give your agent a descriptive name" required>
                </div>
                <div class="form-group my-2">
                    <label for="system_prompt">System Prompt</label>
                    <textarea class="form-control" id="system_prompt" name="system_prompt" rows="3"
                    placeholder="Sets the overall context and behavior of the bot.">{{ agent.system_prompt if clone else '' }}</textarea>
                </div>
                <div class="form-group my-2">
                    <label for="message_prompt">Message Prompt</label>
                    <textarea class="form-control" id="message_prompt" name="message_prompt" rows="3"
                    placeholder="Appended to each user message for consistent context.">{{ agent.message_prompt if clone else '' }}</textarea>
                </div>
            </div>

            <!-- Search Tools Configuration -->
            <div class="form-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Search Tools Configuration</h2>
                    <button type="button" class="btn btn-primary" id="add-search-tool-btn">
                        <i class="bi bi-plus-circle"></i> Add Search Tool
                    </button>
                </div>
                <div id="search-tools-container">
                    <!-- Dynamic Search Tool fields will be added here -->
                    {% if clone %}
                    {% for tool in agent.search_tools %}
                    <div class="border p-3 mb-3 rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Search Tool {{ loop.index }}</h5>
                            <button type="button" class="btn btn-danger btn-sm remove-search-tool">Remove</button>
                        </div>
                        <div class="form-group my-2">
                            <label>Tool Name</label>
                            <input type="text" class="form-control" name="search_names[]" placeholder="Unique identifier for this search tool" value="{{ tool.name }}">
                        </div>
                        <div class="form-group my-2">
                            <label>Method</label>
                            <select class="form-control search-method-select" name="search_methods[]">
                                {% for method_key, method_info in search_methods.items() %}
                                <option value="{{ method_key }}" {{ "selected" if tool.method == method_key else "" }} 
                                    data-description="{{ method_info.description }}">
                                    {{ method_info.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted method-description">
                                {% for method_key, method_info in search_methods.items() %}
                                    {% if tool.method == method_key %}
                                        {{ method_info.description }}
                                    {% endif %}
                                {% endfor %}
                            </small>
                        </div>
                        <div class="form-group my-2">
                            <label>Prefix</label>
                            <input type="text" class="form-control" name="search_prefixes[]" placeholder="Prefix added to all queries using this tool" value="{{ tool.prefix }}">
                        </div>
                        <div class="form-group my-2">
                            <label>Prompt</label>
                            <textarea class="form-control" name="search_prompts[]" rows="2" placeholder="Instructions on when and how to use this tool">{{ tool.prompt }}</textarea>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Chat Model Configuration -->
            <div class="form-section">
                <h2>Chat Model Configuration</h2>
                <div class="form-group my-2">
                    <label for="engine">Engine</label>
                    <select class="form-control" id="engine" name="engine">
                        {% if clone %}
                        <option value="openai" {{ "selected" if agent.engine == "openai" else "" }}>openai</option>
                        <option value="anthropic" {{ "selected" if agent.engine == "anthropic" else "" }}>anthropic</option>
                        <!-- <option value="google" {{ "selected" if agent.engine == "google" else "" }}>google</option>
                        <option value="hive" {{ "selected" if agent.engine == "hive" else "" }}>hive</option> -->
                        {% else %}
                        <option value="openai" selected>openai</option>
                        <option value="anthropic">anthropic</option>
                        <!-- <option value="google">google</option>
                        <option value="hive">hive</option> -->
                        {% endif %}
                    </select>
                </div>
                <div class="form-group my-2">
                    <label for="model">Model</label>
                    <select class="form-control" id="model" name="model">
                        <!-- Options will be populated dynamically based on the selected engine -->
                    </select>
                </div>
                <div class="form-group my-2">
                    <label for="temperature">Model Temperature</label>
                    <input type="number" step="0.1" class="form-control" id="temperature" name="temperature" min="0" max="1" value="{{ agent.temperature if clone else 0 }}"
                    placeholder="Controls randomness in responses: higher values are more random">
                </div>
                <div class="form-group my-2">
                    <label for="seed">Model Seed</label>
                    <input type="number" class="form-control" id="seed" name="seed" min="0" max="100" value="{{ agent.seed if clone else 0 }}"
                    placeholder="Controls randomness in responses: repeated requests with the same seed should produce the same output">
                </div>
                <p class="mt-3"><strong>Review your configuration before creating the bot.</strong></p>
            </div>
            
            <button type="submit" class="btn btn-gradient btn-lg btn-block">{{ "Clone" if clone else "Create" }} Agent</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        // Global variable to store available models
        let availableModels = {};
        
        // Global variable to store search methods data
        let searchMethodsData = {{ search_methods | tojson | safe }};
        
        // Fetch available models when the page loads
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/available_models');
                const data = await response.json();
                
                if (data.message === "Success") {
                    availableModels = data.data;
                    
                    // Initialize model dropdown based on current engine selection
                    updateModelOptions();
                    
                    // Check if we're in clone mode using the hidden input
                    const isCloneMode = document.getElementById('is_clone_mode').value === 'true';
                    
                    // Set default model to gpt-4o if available and not in clone mode
                    if (!isCloneMode && availableModels['openai'] && availableModels['openai'].includes('gpt-4o')) {
                        const modelSelect = document.getElementById('model');
                        for (let i = 0; i < modelSelect.options.length; i++) {
                            if (modelSelect.options[i].value === 'gpt-4o') {
                                modelSelect.options[i].selected = true;
                                break;
                            }
                        }
                    }
                }
                
                // Add event listeners to all search method selects
                setupMethodSelectListeners();
                
                // Check if we're in clone mode using the hidden input
                const isCloneMode = document.getElementById('is_clone_mode').value === 'true';
                
                // Add a default search tool with dynamic_serpapi if creating a new agent
                if (!isCloneMode && document.getElementById('search-tools-container').children.length === 0) {
                    addSearchToolField('web_search', 'dynamic_serpapi', '', 'Use this tool to search the web for current information.');
                }
            } catch (error) {
                console.error('Error fetching available models:', error);
            }
        });
        
        // Function to set up event listeners for method selects
        function setupMethodSelectListeners() {
            // For existing selects
            document.querySelectorAll('.search-method-select').forEach(select => {
                if (!select.hasAttribute('data-listener-attached')) {
                    select.setAttribute('data-listener-attached', 'true');
                    select.addEventListener('change', updateMethodDescription);
                }
            });
        }
        
        // Function to update the method description
        function updateMethodDescription(event) {
            const select = event.target;
            const methodKey = select.value;
            const descriptionElement = select.nextElementSibling;
            
            if (descriptionElement && descriptionElement.classList.contains('method-description')) {
                if (methodKey && searchMethodsData[methodKey]) {
                    descriptionElement.textContent = searchMethodsData[methodKey].description;
                } else {
                    descriptionElement.textContent = 'Select a method to see its description';
                }
            }
        }

        // Update model options when engine changes
        document.getElementById('engine').addEventListener('change', updateModelOptions);
        
        function updateModelOptions() {
            const engineSelect = document.getElementById('engine');
            const modelSelect = document.getElementById('model');
            const selectedEngine = engineSelect.value;
            const isCloneMode = document.getElementById('is_clone_mode').value === 'true';
            
            // Clear existing options
            modelSelect.innerHTML = '';
            
            // Add new options based on selected engine
            if (availableModels[selectedEngine]) {
                availableModels[selectedEngine].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    
                    // If cloning, select the current model
                    {% if clone %}
                    if (model === "{{ agent.model }}") {
                        option.selected = true;
                    }
                    {% endif %}
                    
                    // If not cloning and engine is openai, set gpt-4o as default
                    if (!isCloneMode && selectedEngine === 'openai' && model === 'gpt-4o') {
                        option.selected = true;
                    }
                    
                    modelSelect.appendChild(option);
                });
            } else {
                // If models haven't loaded yet, add a placeholder option
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Loading models...";
                modelSelect.appendChild(option);
            }
        }

        // --- Search Tools Section ---
        function addSearchToolField(name, method, prefix, prompt) {
            const container = document.getElementById('search-tools-container');
            const div = document.createElement('div');
            div.classList.add('border', 'p-3', 'mb-3', 'rounded');
            
            // If no method is specified, default to dynamic_serpapi (web search)
            if (!method) {
                method = 'dynamic_serpapi';
            }
            
            // Generate options HTML for search methods
            let optionsHtml = '';
            for (const [key, info] of Object.entries(searchMethodsData)) {
                optionsHtml += `<option value="${key}" ${method === key ? 'selected' : ''} 
                    data-description="${info.description}">${info.display_name}</option>`;
            }
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <h5>Search Tool</h5>
                    <button type="button" class="btn btn-danger btn-sm remove-search-tool">Remove</button>
                </div>
                <div class="form-group my-2">
                    <label>Tool Name</label>
                    <input type="text" class="form-control" name="search_names[]" placeholder="Unique identifier for this search tool" value="${name}">
                </div>
                <div class="form-group my-2">
                    <label>Method</label>
                    <select class="form-control search-method-select" name="search_methods[]">
                        ${optionsHtml}
                    </select>
                    <small class="form-text text-muted method-description">
                        ${method && searchMethodsData[method] ? searchMethodsData[method].description : 'Select a method to see its description'}
                    </small>
                </div>
                <div class="form-group my-2">
                    <label>Prefix</label>
                    <input type="text" class="form-control" name="search_prefixes[]" placeholder="Prefix added to all queries using this tool" value="${prefix}">
                </div>
                <div class="form-group my-2">
                    <label>Prompt</label>
                    <textarea class="form-control" name="search_prompts[]" rows="2" placeholder="Instructions on when and how to use this tool">${prompt}</textarea>
                </div>
            `;
            // Attach event listener for the remove button
            div.querySelector('.remove-search-tool').addEventListener('click', function() {
                div.remove();
                reIndexSearchToolFields();
            });
            
            // Attach event listener for the method select
            const methodSelect = div.querySelector('.search-method-select');
            if (methodSelect) {
                methodSelect.setAttribute('data-listener-attached', 'true');
                methodSelect.addEventListener('change', updateMethodDescription);
            }
            
            container.appendChild(div);
            reIndexSearchToolFields();
        }

        function reIndexSearchToolFields() {
            const container = document.getElementById('search-tools-container');
            const groups = container.children;
            for (let i = 0; i < groups.length; i++) {
                groups[i].querySelector('h5').innerText = `Search Tool ${i + 1}`;
            }
        }

        // Attach event listeners to the Add button
        document.getElementById('add-search-tool-btn').addEventListener('click', () => addSearchToolField('web_search', 'dynamic_serpapi', '', 'Use this tool to search the web for current information.'));
    </script>
</body>
</html>
